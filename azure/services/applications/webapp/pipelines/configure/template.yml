parameters:
- name: environments
  type: object
  default: []

- name: common
  type: object
  default: []


stages:
- ${{ each env in parameters.environments }}:
  - ${{ if eq(env.manualValidation, true) }}:
    - stage: ${{ env.shortName }}_pre_config
      jobs:
      - template: /azure/services/common/tasks/manual_validation/template.yml@cloud-shell 
        parameters:
          jobName:  ${{ env.shortName }}_manual_validation
          displayName: Manual Validation
          jobTimeoutInMinutes:  ${{ coalesce(env.common.jobTimeoutInMinutes, parameters.common.jobTimeoutInMinutes) }}
          taskTimeoutInMinutes:  ${{ coalesce(env.common.taskTimeoutInMinutes, parameters.common.taskTimeoutInMinutes) }}
          onTimeout: ${{ coalesce(env.common.onTimeout, parameters.common.onTimeout) }}

  - stage: ${{ env.shortName }}_config
    jobs:
    - ${{ each deployment in env.deployments }}:
      - template: /azure/services/applications/webapp/tasks/configure/template.yml@cloud-shell
        parameters:
          deploymentName: ${{ deployment.name }}
          environmentName: ${{ env.fullName }}  
          condition: ${{ coalesce(deployment.condition, env.common.condition, parameters.common.condition, true) }}
          dependsOn: ${{ deployment.dependsOn }}
          resourceGroup: ${{ coalesce(deployment.resourceGroup, env.common.resourceGroup, parameters.common.resourceGroup, false) }} 
          serviceConnection: ${{ coalesce(deployment.serviceConnection, env.common.serviceConnection, parameters.common.serviceConnection, false) }}
          deploymentSlot: ${{ coalesce(deployment.deploymentSlot, env.common.deploymentSlot, parameters.common.deploymentSlot, 'production') }}
          webAppName: ${{ coalesce(deployment.webAppName, env.common.webAppName, parameters.common.webAppName, false) }}
          webAppSettings:
            - ${{ each settingsFile in parameters.common.webAppSettings }}:
                - ${{ settingsFile }}
            - ${{ each settingsFile in env.common.webAppSettings }}:
                - ${{ settingsFile }}
            - ${{ each settingsFile in deployment.webAppSettings }}:
                - ${{ settingsFile }}